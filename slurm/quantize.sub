#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=qwen_gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32G
#SBATCH --output=logs/qwen2.5-32b-instruct/output_qwen_gptq.log
#SBATCH --error=logs/qwen2.5-32b-instruct/error_qwen_gptq.log

set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENOï¼Œé€€å‡ºç  $?" >&2; exit 1' ERR

echo "ğŸ” ä½œä¸šå¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
cd "$SLURM_SUBMIT_DIR"

# ===== æ¨¡å—åŠ è½½ï¼ˆAISurreyï¼‰=====
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh
    module load apptainer || echo "âš ï¸ Apptainer æ¨¡å—åŠ è½½å¤±è´¥ï¼Œç¡®ä¿å·²å®‰è£…"
fi

# ===== è®¾ç½®ç¼“å­˜è·¯å¾„ï¼ˆé¿å… /tmp ç©ºé—´ä¸è¶³ï¼‰=====
export APPTAINER_TMPDIR="/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/apptainer_tmp"
export APPTAINER_CACHEDIR="/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/apptainer_cache"
mkdir -p "$APPTAINER_TMPDIR" "$APPTAINER_CACHEDIR"

# ===== é¡¹ç›®ä¸å®¹å™¨å®šä¹‰ =====
WORKDIR="$SLURM_SUBMIT_DIR"
DEF_FILE="$WORKDIR/build_GPTQModel/apptainer.def"
SIF_FILE="$WORKDIR/build_GPTQModel/qwen-gptq.sif"

# ===== æ¨¡å‹è·¯å¾„ä¸é…ç½® =====
MODEL_ID="Qwen/Qwen2.5-32B-Instruct"
CONFIG="$WORKDIR/configs/qwen_32b_gptq.yaml"
OUTPUT_DIR="$WORKDIR/quantized_models/qwen-32b-gptq-v2"
CACHE_DIR="$WORKDIR/original_models"
mkdir -p "$OUTPUT_DIR" "$CACHE_DIR"

# ===== æ„å»ºå®¹å™¨ï¼ˆå¦‚å¿…è¦ï¼‰=====
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "ğŸ“¦ å¼€å§‹æ„å»ºå®¹å™¨é•œåƒ..."

    TMP_SIF="/tmp/qwen-gptq-${SLURM_JOB_ID}.sif"
    echo "ğŸ“¦ æ„å»ºåˆ°ä¸´æ—¶è·¯å¾„: $TMP_SIF"
    
    apptainer build "$TMP_SIF" "$DEF_FILE"

    mv "$TMP_SIF" "$SIF_FILE"
    echo "âœ… å®¹å™¨æ„å»ºå®Œæˆå¹¶ç§»åŠ¨åˆ°: $SIF_FILE"
else
    echo "âœ… å®¹å™¨é•œåƒå·²æ˜¯æœ€æ–°: $SIF_FILE"
fi

# ===== å®¹å™¨å¥åº·æ£€æŸ¥ =====
echo "ğŸ©º å¼€å§‹å®¹å™¨å¥åº·æ£€æŸ¥..."
apptainer exec --nv "$SIF_FILE" python -c \
"import torch; print(f'PyTorch ç‰ˆæœ¬: {torch.__version__}, CUDA å¯ç”¨: {torch.cuda.is_available()}')"

# ===== å¯åŠ¨é‡åŒ–ä»»åŠ¡ =====
echo "ğŸš€ å¯åŠ¨ GPTQ é‡åŒ–ä»»åŠ¡..."
apptainer exec --nv \
    --bind "$WORKDIR:/opt/project" \
    --bind "$CACHE_DIR:/hf_cache" \
    "$SIF_FILE" \
    python /opt/quantize.py \
        --model_id "$MODEL_ID" \
        --output_dir "$OUTPUT_DIR" \
        --config "$CONFIG" \
        --cache_dir /hf_cache

# ===== å®Œæˆæ ‡è®° =====
echo "âœ… ä½œä¸šå®Œæˆ: $(date)"
touch "$OUTPUT_DIR/COMPLETED"

#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=qwen_gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32G
#SBATCH --output=logs/quant_%j.log
#SBATCH --error=logs/quant_%j.err

# 初始化环境
LOG_DIR="logs"
mkdir -p "$LOG_DIR"
DEF_FILE="build_GPTQModel/apptainer.def"
SIF_FILE="build_GPTQModel/qwen-gptq.sif"

# 构建容器（如果需要）
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "Building container..."
    apptainer build "$SIF_FILE" "$DEF_FILE"
fi

# 运行量化
apptainer exec --nv "$SIF_FILE" \
    python /opt/quantize.py \
        --model_path /path/to/Qwen2.5-32B-Instruct \
        --output_dir ./quantized_models/qwen-32b-gptq-v2 \
        --config configs/qwen_32b_gptq.yaml

#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=qwen_gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32G
#SBATCH --output=logs/quant_%j.log
#SBATCH --error=logs/quant_%j.err

# ===== ç”¨æˆ·é…ç½®åŒº =====
# è®¾ç½® Hugging Face æ¨¡åž‹ IDï¼ˆå…¬å¼€æˆ–ç§æœ‰æ¨¡åž‹ï¼‰
MODEL_ID="Qwen/Qwen2.5-32B-Instruct"

# è®¾ç½®è¾“å‡ºç›®å½•
OUTPUT_DIR="./quantized_models/qwen-32b-gptq-v2"

# è®¾ç½®é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG="configs/qwen_32b_gptq.yaml"

# è®¾ç½® Hugging Face ç¼“å­˜ç›®å½•ï¼ˆæŽ¨èä½¿ç”¨é›†ç¾¤æŒä¹…å­˜å‚¨ï¼‰
CACHE_DIR="/vol/research/ly0008/ysh/hf_cache"

# è®¾ç½® Hugging Face è®¿é—®ä»¤ç‰Œï¼ˆä»…ç§æœ‰æ¨¡åž‹éœ€è¦ï¼‰
# export HF_TOKEN="your_huggingface_token"

# ===== ç³»ç»Ÿè®¾ç½® =====
set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENOï¼Œé€€å‡ºç  $?" >&2; exit 1' ERR

# èŽ·å–ä½œä¸šID
JOB_ID=${SLURM_JOB_ID:-$(date +%s)}
echo "ðŸ†” ä½œä¸šID: $JOB_ID"

# åˆ›å»ºæ—¥å¿—ç›®å½•
LOG_DIR="logs"
mkdir -p "$LOG_DIR"
echo "ðŸ“ æ—¥å¿—ç›®å½•: $LOG_DIR"

# å®¹å™¨æ–‡ä»¶è·¯å¾„
DEF_FILE="build_GPTQModel/apptainer.def"
SIF_FILE="build_GPTQModel/qwen-gptq.sif"
echo "ðŸ”§ å®¹å™¨å®šä¹‰: $DEF_FILE"
echo "ðŸ“¦ å®¹å™¨é•œåƒ: $SIF_FILE"

# åˆ›å»ºç¼“å­˜ç›®å½•
mkdir -p "$CACHE_DIR"
echo "ðŸ“¦ ç¼“å­˜ç›®å½•: $CACHE_DIR (å¤§å°: $(du -sh $CACHE_DIR | cut -f1))"

# ===== å®¹å™¨æž„å»º =====
BUILD_LOG="$LOG_DIR/container_build_$JOB_ID.log"
echo -e "\nðŸš§ æ£€æŸ¥å®¹å™¨é•œåƒ..."
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "ðŸ› ï¸ éœ€è¦æž„å»ºå®¹å™¨..."
    
    # æ¸…ç†æ—§æž„å»ºç¼“å­˜
    echo "ðŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    find "/tmp" -name "apptainer-build-temp-*" -user $(whoami) -mtime +1 -exec rm -rf {} \; 2>/dev/null || true
    
    # å°è¯•æž„å»ºå®¹å™¨ï¼ˆæœ€å¤š3æ¬¡ï¼‰
    for ATTEMPT in {1..3}; do
        echo "ðŸ”¨ æž„å»ºå°è¯• #$ATTEMPT..."
        if apptainer build "$SIF_FILE" "$DEF_FILE" 2>&1 | tee "$BUILD_LOG"; then
            if [ -f "$SIF_FILE" ]; then
                echo "âœ… å®¹å™¨æž„å»ºæˆåŠŸ!"
                break
            else
                echo "âŒ å®¹å™¨æ–‡ä»¶æœªç”Ÿæˆï¼Œå¯èƒ½å†…éƒ¨é”™è¯¯"
            fi
        else
            BUILD_EXIT_CODE=${PIPESTATUS[0]}
            echo "âŒ æž„å»ºå¤±è´¥ (é€€å‡ºç  $BUILD_EXIT_CODE)ï¼Œç­‰å¾…é‡è¯•..."
        fi
        
        if [ $ATTEMPT -lt 3 ]; then
            sleep $((ATTEMPT * 30))
        else
            echo "ðŸ”¥ å®¹å™¨æž„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—: $BUILD_LOG"
            echo "å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:"
            echo "1. æ£€æŸ¥ç£ç›˜ç©ºé—´: df -h"
            echo "2. ç¡®ä¿æœ‰è¶³å¤Ÿæƒé™"
            echo "3. å°è¯•æ‰‹åŠ¨æž„å»º: apptainer build $SIF_FILE $DEF_FILE"
            exit 1
        fi
    done
else
    echo "âœ… å®¹å™¨é•œåƒå·²å­˜åœ¨ä¸”æ˜¯æœ€æ–°çš„"
fi

# ===== å®¹å™¨å¥åº·æ£€æŸ¥ =====
echo -e "\nðŸ” è¿è¡Œå®¹å™¨å¥åº·æ£€æŸ¥..."
CHECK_LOG="$LOG_DIR/container_check_$JOB_ID.log"
if ! apptainer exec --nv "$SIF_FILE" bash -c \
    "python -c \"import torch; print(f'PyTorchç‰ˆæœ¬: {torch.__version__}, CUDAå¯ç”¨: {torch.cuda.is_available()}')\"" \
    2>&1 | tee "$CHECK_LOG"; then
    
    echo "ðŸ”¥ å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
    echo "å¯èƒ½åŽŸå› :"
    echo "1. CUDAé©±åŠ¨ä¸å…¼å®¹"
    echo "2. PyTorchå®‰è£…é—®é¢˜"
    echo "3. å®¹å™¨å†…éƒ¨é”™è¯¯"
    exit 1
fi

# éªŒè¯æ£€æŸ¥ç»“æžœ
if grep -q "CUDAå¯ç”¨: True" "$CHECK_LOG"; then
    echo "âœ… å®¹å™¨å¥åº·æ£€æŸ¥é€šè¿‡"
else
    echo "ðŸ”¥ CUDAä¸å¯ç”¨ï¼Œæ£€æŸ¥æ—¥å¿—: $CHECK_LOG"
    echo "æœ€åŽä¸€èŠ‚æ—¥å¿—:"
    tail -n 20 "$CHECK_LOG"
    exit 1
fi

# ===== é‡åŒ–ä»»åŠ¡ =====
echo -e "\nðŸš€ å¯åŠ¨é‡åŒ–ä»»åŠ¡..."
QUANT_LOG="$LOG_DIR/quant_task_$JOB_ID.log"
echo "===== é‡åŒ–å‚æ•° =====" | tee "$QUANT_LOG"
echo "æ¨¡åž‹ID: $MODEL_ID" | tee -a "$QUANT_LOG"
echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR" | tee -a "$QUANT_LOG"
echo "é…ç½®æ–‡ä»¶: $CONFIG" | tee -a "$QUANT_LOG"
echo "ç¼“å­˜ç›®å½•: $CACHE_DIR" | tee -a "$QUANT_LOG"
echo "å¼€å§‹æ—¶é—´: $(date)" | tee -a "$QUANT_LOG"
echo "====================" | tee -a "$QUANT_LOG"

# å‡†å¤‡çŽ¯å¢ƒå˜é‡
ENV_VARS=""
if [ -n "${HF_TOKEN:-}" ]; then
    echo "ðŸ”‘ æ£€æµ‹åˆ° HF_TOKENï¼Œå°†ç”¨äºŽç§æœ‰æ¨¡åž‹è®¿é—®" | tee -a "$QUANT_LOG"
    ENV_VARS="--env HF_TOKEN=$HF_TOKEN"
fi

# è¿è¡Œé‡åŒ–å‘½ä»¤
echo "â¬ å¼€å§‹ä¸‹è½½å’Œé‡åŒ–æ¨¡åž‹..." | tee -a "$QUANT_LOG"
if ! apptainer exec --nv \
    $ENV_VARS \
    --bind "$CACHE_DIR:/hf_cache" \
    "$SIF_FILE" \
    python /opt/quantize.py \
        --model_id "$MODEL_ID" \
        --output_dir "$OUTPUT_DIR" \
        --config "$CONFIG" \
        --cache_dir /hf_cache \
    2>&1 | tee -a "$QUANT_LOG"; then
    
    QUANT_EXIT_CODE=${PIPESTATUS[0]}
    echo "ðŸ”¥ é‡åŒ–ä»»åŠ¡å¤±è´¥ (é€€å‡ºç  $QUANT_EXIT_CODE)" | tee -a "$QUANT_LOG"
    echo "æŸ¥çœ‹æ—¥å¿—: $QUANT_LOG" | tee -a "$QUANT_LOG"
    echo "æœ€åŽä¸€èŠ‚æ—¥å¿—:" | tee -a "$QUANT_LOG"
    tail -n 30 "$QUANT_LOG" | tee -a "$QUANT_LOG"
    
    # æä¾›è¯Šæ–­å»ºè®®
    echo "å¯èƒ½åŽŸå› åŠè§£å†³æ–¹æ¡ˆ:" | tee -a "$QUANT_LOG"
    echo "1. ç½‘ç»œé—®é¢˜: æ£€æŸ¥é›†ç¾¤æ˜¯å¦èƒ½è®¿é—® huggingface.co" | tee -a "$QUANT_LOG"
    echo "2. æ¨¡åž‹IDé”™è¯¯: ç¡®è®¤ '$MODEL_ID' æ˜¯æœ‰æ•ˆçš„ Hugging Face æ¨¡åž‹" | tee -a "$QUANT_LOG"
    echo "3. æ˜¾å­˜ä¸è¶³: å°è¯•å‡å°‘æ ¡å‡†æ•°æ®é‡æˆ–ä½¿ç”¨æ›´å¤§ GPU" | tee -a "$QUANT_LOG"
    echo "4. ç¼“å­˜é—®é¢˜: å°è¯•åˆ é™¤ç¼“å­˜ç›®å½• $CACHE_DIR å¹¶é‡è¯•" | tee -a "$QUANT_LOG"
    
    exit 1
fi

# æ£€æŸ¥é‡åŒ–ç»“æžœ
echo -e "\nðŸ”Ž éªŒè¯é‡åŒ–ç»“æžœ..." | tee -a "$QUANT_LOG"
if [ -f "$OUTPUT_DIR/COMPLETED" ]; then
    echo "âœ… é‡åŒ–æˆåŠŸå®Œæˆ!" | tee -a "$QUANT_LOG"
    echo "æ¨¡åž‹å¤§å°: $(du -sh $OUTPUT_DIR | cut -f1)" | tee -a "$QUANT_LOG"
    echo "è¾“å‡ºæ–‡ä»¶:" | tee -a "$QUANT_LOG"
    ls -lh "$OUTPUT_DIR" | tee -a "$QUANT_LOG"
else
    echo "âŒ é‡åŒ–æœªå®Œæˆï¼Œç¼ºå°‘COMPLETEDæ ‡è®°" | tee -a "$QUANT_LOG"
    echo "å¯èƒ½åŽŸå› :" | tee -a "$QUANT_LOG"
    echo "1. è„šæœ¬æå‰é€€å‡º" | tee -a "$QUANT_LOG"
    echo "2. å­˜å‚¨ç©ºé—´ä¸è¶³" | tee -a "$QUANT_LOG"
    echo "3. æƒé™é—®é¢˜" | tee -a "$QUANT_LOG"
    exit 1
fi

echo "ç»“æŸæ—¶é—´: $(date)" | tee -a "$QUANT_LOG"
echo "====================" | tee -a "$QUANT_LOG"

# ===== æœ€ç»ˆçŠ¶æ€ =====
echo -e "\nðŸ ä»»åŠ¡å®Œæˆ! è¯¦ç»†æ—¥å¿—:"
echo "  - å®¹å™¨æž„å»º: $BUILD_LOG"
echo "  - å¥åº·æ£€æŸ¥: $CHECK_LOG"
echo "  - é‡åŒ–è¿‡ç¨‹: $QUANT_LOG"
echo "  - è¾“å‡ºæ¨¡åž‹: $OUTPUT_DIR"

# æ·»åŠ æˆåŠŸæ ‡è®°
touch "$OUTPUT_DIR/JOB_$JOB_ID_SUCCESS"
echo "âœ… é‡åŒ–ä»»åŠ¡ $JOB_ID æˆåŠŸå®ŒæˆäºŽ $(date)" > "$OUTPUT_DIR/JOB_$JOB_ID_SUCCESS"

exit 0
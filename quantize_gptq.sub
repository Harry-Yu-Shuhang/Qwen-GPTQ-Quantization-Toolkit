#!/bin/bash
#SBATCH --job-name=qwen_gptq                # ä½œä¸šå
#SBATCH --partition=a100                    # ä½¿ç”¨ a100 åˆ†åŒº
#SBATCH --nodelist=aisurrey15               # èŠ‚ç‚¹åç§°
#SBATCH --nodes=1                           # å•èŠ‚ç‚¹ï¼ˆé€‚ç”¨äºGPTQå•å¡ï¼‰
#SBATCH --ntasks=1                          # å•ä»»åŠ¡
#SBATCH --ntasks-per-node=1                 # æ¯ä¸ªèŠ‚ç‚¹1ä»»åŠ¡
#SBATCH --cpus-per-task=32                  # æ¯ä»»åŠ¡ 32 CPUï¼Œç”¨äºåŠ é€Ÿå¤„ç†
#SBATCH --gpus-per-node=1                   # æ¯èŠ‚ç‚¹1å—GPU
#SBATCH --mem=512G                          # å†…å­˜ä¸º512GBï¼ˆé¿å…OOMï¼‰
#SBATCH --time=1-00:00:00                   # æœ€é•¿è¿è¡Œ1å¤©
#SBATCH --exclusive                         # ç‹¬å æ•´ä¸ªèŠ‚ç‚¹
#SBATCH --output=logs/output_%j.log         # æ ‡å‡†è¾“å‡º
#SBATCH --error=logs/error_%j.log           # é”™è¯¯è¾“å‡º


set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENO, é€€å‡ºç  $?"' ERR

echo "ğŸ” ä½œä¸šå¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
cd "$SLURM_SUBMIT_DIR"

DEF_FILE="build_GPTQModel/apptainer.def"
SIF_FILE="build_GPTQModel/qwen-gptq.sif"
OUTPUT_DIR="quantized_models/qwen-32b-gptq"

# ä½¿ç”¨ /tmp é¿å… I/O é”™è¯¯
export APPTAINER_TMPDIR=/tmp
export APPTAINER_CACHEDIR=/tmp

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "$OUTPUT_DIR"

# æ„å»ºé•œåƒï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "ğŸ“¦ æ„å»º Apptainer é•œåƒ..."
    apptainer build --force "$SIF_FILE" "$DEF_FILE"
else
    echo "âœ… é•œåƒå·²æ˜¯æœ€æ–°: $SIF_FILE"
fi

# å¯åŠ¨é‡åŒ–ä»»åŠ¡
echo "ğŸš€ å¯åŠ¨ GPTQ é‡åŒ–..."
apptainer run --nv "$SIF_FILE" \
    --model_id Qwen/Qwen2.5-32B-Instruct \
    --output_dir "/mnt/fast/nobackup/scratch4weeks/ly0008/ysh/Qwen-GPTQ-Quantization-Toolkit/${OUTPUT_DIR}" \
    --config /opt/app/configs/qwen_32b_gptq.yaml \
    --cache_dir /tmp/hf_cache

echo "âœ… ä»»åŠ¡å®Œæˆ: $(date)"

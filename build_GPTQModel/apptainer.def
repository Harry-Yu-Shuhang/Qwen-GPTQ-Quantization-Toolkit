Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu22.04

%labels
    Author ShuhangYu
    Description Apptainer image for Qwen GPTQ Compression (AutoGPTQ + PyTorch 2.3)

%files
    install.sh /opt/install.sh
    ../GPTQModel /opt/GPTQModel
    ../quantize.py /opt/project/quantize.py
    ../configs /opt/project/configs

%environment
    export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    export TRANSFORMERS_CACHE=/tmp/hf_cache
    export HF_HOME=/tmp/hf_cache
    export PYTHONPATH=/opt/project:/opt/GPTQModel

%post
    set -eEuo pipefail
    trap 'echo "❌ 安装失败: 行号 $LINENO，命令: $BASH_COMMAND" >&2; exit 1' ERR

    echo "🔧 初始化 Conda 环境..."
    apt update && apt install -y wget git bzip2
    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /opt/conda
    export PATH=/opt/conda/bin:$PATH
    conda init bash

    echo "📦 安装依赖包..."
    bash /opt/install.sh

%runscript
    exec python /opt/project/quantize.py "$@"

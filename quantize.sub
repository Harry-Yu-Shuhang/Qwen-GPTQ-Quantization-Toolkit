#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=qwen_gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32G
#SBATCH --output=logs/output_qwen_gptq.log
#SBATCH --error=logs/error_qwen_gptq.log

set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENOï¼Œé€€å‡ºç  $?" >&2; exit 1' ERR

echo "ğŸ” ä½œä¸šå¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
cd "$SLURM_SUBMIT_DIR" || { echo "âŒ æ— æ³•è¿›å…¥æäº¤ç›®å½•"; exit 1; }

# ===== Apptainer ç¯å¢ƒåŠ è½½ =====
if [ -f /etc/profile.d/modules.sh ]; then
    source /etc/profile.d/modules.sh || true
    module load apptainer || echo "âš ï¸ Apptainer æ¨¡å—åŠ è½½å¤±è´¥ï¼Œç¡®ä¿ç³»ç»Ÿå·²å®‰è£…"
fi

# ===== è®¾ç½® Apptainer ç¼“å­˜ç›®å½• =====
export APPTAINER_TMPDIR="$PWD/apptainer_tmp"
export APPTAINER_CACHEDIR="$PWD/apptainer_cache"
mkdir -p "$APPTAINER_TMPDIR" "$APPTAINER_CACHEDIR"
echo "ğŸ“¦ ç¼“å­˜è·¯å¾„: $APPTAINER_TMPDIR, $APPTAINER_CACHEDIR"

# ===== å®¹å™¨å®šä¹‰ä¸é•œåƒè·¯å¾„ =====
DEF_FILE="build_GPTQModel/apptainer.def"
SIF_FILE="build_GPTQModel/qwen-gptq.sif"

# ===== æ¨¡å‹è·¯å¾„ä¸è¾“å‡ºç›®å½•ï¼ˆå¯æŒ‰éœ€ä¿®æ”¹ï¼‰=====
MODEL_ID="Qwen/Qwen2.5-32B-Instruct"
OUTPUT_DIR="$PWD/quantized_models/qwen2.5-32b-gptq"
CONFIG_FILE="$PWD/configs/qwen_32b_gptq.yaml"
CACHE_DIR="$PWD/original_models"
mkdir -p "$OUTPUT_DIR" "$CACHE_DIR"

# ===== æ„å»ºå®¹å™¨ï¼ˆå¦‚å¿…è¦ï¼‰=====
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "ğŸ“¦ æ­£åœ¨æ„å»ºå®¹å™¨é•œåƒ: $SIF_FILE"
    rm -f "$SIF_FILE"
    apptainer build "$SIF_FILE" "$DEF_FILE"
else
    echo "âœ… å®¹å™¨é•œåƒå·²æ˜¯æœ€æ–°: $SIF_FILE"
fi

# ===== å¥åº·æ£€æŸ¥ =====
echo "ğŸ©º å®¹å™¨å¥åº·æ£€æŸ¥..."
apptainer exec --nv "$SIF_FILE" python -c "import torch; print(f'PyTorchç‰ˆæœ¬: {torch.__version__}, CUDAå¯ç”¨: {torch.cuda.is_available()}')"

# ===== å¯åŠ¨é‡åŒ–ä»»åŠ¡ =====
echo "ğŸš€ æ‰§è¡Œé‡åŒ–ä»»åŠ¡..."
apptainer exec --nv \
    --bind "$PWD:/opt/project" \
    --bind "$CACHE_DIR:/hf_cache" \
    "$SIF_FILE" \
    python /opt/project/quantize.py \
        --model_id "$MODEL_ID" \
        --output_dir "$OUTPUT_DIR" \
        --config "$CONFIG_FILE" \
        --cache_dir /hf_cache

echo "âœ… ä»»åŠ¡å®Œæˆ: $(date)"
touch "$OUTPUT_DIR/COMPLETED"

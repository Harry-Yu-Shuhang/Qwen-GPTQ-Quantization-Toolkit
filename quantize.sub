#!/bin/bash
#SBATCH --partition=debug
#SBATCH --job-name=qwen_gptq
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gpus-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --time=4:00:00
#SBATCH --mem=32G
#SBATCH --output=logs/output_qwen_gptq.log
#SBATCH --error=logs/error_qwen_gptq.log

set -eEuo pipefail
trap 'echo "âŒ ä»»åŠ¡å¤±è´¥: è¡Œå· $LINENO, é€€å‡ºç  $?"' ERR

echo "ğŸ” ä½œä¸šå¼€å§‹: $(date)"
echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
cd "$SLURM_SUBMIT_DIR"

DEF_FILE="build_GPTQModel/apptainer.def"
SIF_FILE="build_GPTQModel/qwen-gptq.sif"
OUTPUT_DIR="quantized_models/qwen-32b-gptq"

# ä½¿ç”¨ /tmp é¿å… I/O é”™è¯¯
export APPTAINER_TMPDIR=/tmp
export APPTAINER_CACHEDIR=/tmp

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p "$OUTPUT_DIR"

# æ„å»ºé•œåƒï¼ˆå¦‚æœ‰å¿…è¦ï¼‰
if [ ! -f "$SIF_FILE" ] || [ "$DEF_FILE" -nt "$SIF_FILE" ]; then
    echo "ğŸ“¦ æ„å»º Apptainer é•œåƒ..."
    apptainer build --force "$SIF_FILE" "$DEF_FILE"
else
    echo "âœ… é•œåƒå·²æ˜¯æœ€æ–°: $SIF_FILE"
fi

# å¯åŠ¨é‡åŒ–ä»»åŠ¡
echo "ğŸš€ å¯åŠ¨ GPTQ é‡åŒ–..."
apptainer run --nv "$SIF_FILE" \
    --model_id Qwen/Qwen2.5-32B-Instruct \
    --output_dir " /mnt/fast/nobackup/scratch4weeks/ly0008/ysh/${OUTPUT_DIR}" \
    --config /opt/configs/qwen_32b_gptq.yaml \
    --cache_dir /tmp/hf_cache

echo "âœ… ä»»åŠ¡å®Œæˆ: $(date)"
